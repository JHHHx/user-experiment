<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具验证界面</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            max-height: 100vh;
            box-sizing: border-box;
        }
        .progress-header {
            font-size: 1.3rem;
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        .content-wrapper {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            padding: 1rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin: 0 2rem;
            height: calc(100vh - 200px);
            min-height: 800px;
            overflow: auto;
        }
        .left-panel, .tool-results {
            display: flex;
        }
        .left-panel {
            width: 25%;
            min-width: 300px;
            height: 100%;
        }
        .tool-results {
            width: 75%;
            display: flex;
            flex-direction: row;
            gap: 1rem;
            flex: 1;
            height: 100%;
            position: relative;
        }
        .image-section, .tool-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }
        .section-title, .tool-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .view-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        .view-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
            min-width: 80px;
        }
        .view-btn.active {
            background: #3498db;
            color: #fff;
            border-color: #3498db;
        }
        .annotation-type {
            font-size: 1rem;
            color: #2c3e50;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #fff;
            border-radius: 4px;
            display: none;
        }
        .annotation-type.show {
            display: block;
        }
        .img-container, .tool-img-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin: 0.5rem 0;
            position: relative;
            height: 100%;
        }
        .img-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }
        .tool-img {
            max-width: 100%;
            height: 700px;
            width: auto;
            object-fit: contain;
        }
        .no-dp-message {
            display: none;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 2rem;
            margin: auto;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .next-btn {
            margin: 1rem auto;
            display: block;
            width: 300px;
            max-width: 90vw;
            padding: 0.8rem;
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .tool-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 1rem;
            height: 100%;
            position: relative;
        }
        .dp-type-buttons {
            display: none; /* 默认隐藏 */
            position: absolute;
            left: 100%; /* 定位到第一个tool-card的右边 */
            top: 10%; /* 调整到上部 */
            transform: translate(-50%, -50%);
            flex-direction: column;
            gap: 1.2rem;
            z-index: 10;
            width: 120px;
            align-items: center;
        }
        .dp-type-title {
            font-size: 0.9rem;
            color: #333;
            text-align: center;
            margin-bottom: 0.8rem;
            font-weight: bold;
            line-height: 1.4;
            text-shadow: 0 0 5px white, 0 0 10px white, 0 0 15px white;
        }
        .dp-type-btn {
            padding: 0;
            width: 3rem; /* 稍微减小按钮尺寸 */
            height: 3rem;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .dp-type-btn::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            transition: all 0.3s ease;
            opacity: 0;
            border: 3px solid transparent;
        }
        .dp-type-btn.red {
            background: #e74c3c;
        }
        .dp-type-btn.blue {
            background: #3498db;
        }
        .dp-type-btn.active::after {
            opacity: 1;
            border-color: currentColor;
        }
        .dp-type-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        .dp-type-btn.active {
            transform: scale(1.15);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        .question-popup {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .question-trigger {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .question-trigger:hover {
            transform: scale(1.1);
            background: #2980b9;
        }
        .question-hint {
            color: #666;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        .question-content {
            position: fixed;
            top: 0;
            left: 0;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 380px;
            max-width: calc(100vw - 100px);
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 99999;
            cursor: move;
        }
        .question-content.show {
            display: block;
        }
        .question-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #2c3e50;
            line-height: 1.4;
        }
        .question-text {
            flex: 1;
            margin-right: 1rem;
        }
        .rating-options {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .rating-option {
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }
        .rating-option input[type="radio"] {
            margin: 0;
            width: 1rem;
            height: 1rem;
        }
        .rating-option label {
            font-size: 0.8rem;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }
        .overlay.show {
            display: block;
        }
        .reminder-message {
            color: #e74c3c;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 0.5rem;
            display: none;
        }
    </style>
    <script src="disable-back.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <div class="container">
                        <div class="progress-header" id="progress-header">工具验证 第1张（共14张）</div>
        <div class="content-wrapper">
            <!-- 左侧面板 -->
            <div class="left-panel">
                <!-- 图片区域 -->
                <div class="image-section">
                    <div class="section-title">图片查看</div>
                    <div class="view-buttons" id="view-buttons">
                        <button class="view-btn active" data-index="-1">原图</button>
                    </div>
                    <div id="annotation-type" class="annotation-type"></div>
                    <div class="img-container">
                        <img id="display-img" src="" alt="显示图片">
                    </div>
                </div>
            </div>
            <!-- 右侧工具验证结果 -->
            <div class="tool-results" id="tool-results">
                <div class="tool-card">
                    <div class="tool-title">界面暗黑模式标注</div>
                    <div class="tool-img-container">
                        <div class="question-popup">
                            <div class="question-trigger">?</div>
                            <div class="question-hint">点击回答问题</div>
                            <div class="question-content">
                                <div class="question-item">
                                    <div class="question-text">您认为显示出该暗黑模式的位置信息是否有价值？</div>
                                    <div class="rating-options">
                                        <div class="rating-option"><input type="radio" name="location_value" value="1"><label>1</label></div>
                                        <div class="rating-option"><input type="radio" name="location_value" value="2"><label>2</label></div>
                                        <div class="rating-option"><input type="radio" name="location_value" value="3"><label>3</label></div>
                                        <div class="rating-option"><input type="radio" name="location_value" value="4"><label>4</label></div>
                                        <div class="rating-option"><input type="radio" name="location_value" value="5"><label>5（分数制）</label></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <img class="tool-img" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzwvdGV4dD4KPC9zdmc+" alt="工具结果1">
                    </div>
                </div>
                <div class="tool-card">
                    <div class="tool-title">界面暗黑模式基本信息</div>
                    <div class="tool-img-container">
                        <div class="question-popup">
                            <div class="question-trigger">?</div>
                            <div class="question-hint">点击回答问题</div>
                            <div class="question-content">
                                <!-- 问题内容将通过JavaScript动态生成 -->
                            </div>
                        </div>
                        <!-- 红色弹窗触发按钮 -->
                        <div class="dp-popup-trigger red-trigger" id="redTrigger" style="position: absolute; top: 10px; right: 60px; width: 30px; height: 30px; border-radius: 50%; background: #f44336; color: white; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">红</div>
                        <!-- 蓝色弹窗触发按钮 -->
                        <div class="dp-popup-trigger blue-trigger" id="blueTrigger" style="position: absolute; top: 10px; right: 100px; width: 30px; height: 30px; border-radius: 50%; background: #2196f3; color: white; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">蓝</div>
                        <img class="tool-img" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzwvdGV4dD4KPC9zdmc+" alt="工具结果2">
                    </div>
                </div>
                <div class="tool-card">
                    <div class="tool-title">界面暗黑模式详细信息</div>
                    <div class="tool-img-container">
                        <div class="question-popup">
                            <div class="question-trigger">?</div>
                            <div class="question-hint">点击回答问题</div>
                            <div class="question-content" id="detail-info-questions">
                                <!-- 问题将从JSON动态加载 -->
                            </div>
                        </div>
                        <!-- 红色弹窗触发按钮 -->
                        <div class="dp-popup-trigger red-trigger" id="redDetailTrigger" style="position: absolute; top: 10px; right: 60px; width: 30px; height: 30px; border-radius: 50%; background: #f44336; color: white; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">红</div>
                        <!-- 蓝色弹窗触发按钮 -->
                        <div class="dp-popup-trigger blue-trigger" id="blueDetailTrigger" style="position: absolute; top: 10px; right: 100px; width: 30px; height: 30px; border-radius: 50%; background: #2196f3; color: white; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">蓝</div>
                        <img class="tool-img" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuekuuS+i+WbvueJhzwvdGV4dD4KPC9zdmc+" alt="工具结果3">
                    </div>
                </div>
                <div class="no-dp-message" id="no-dp-message">
                    该图片没有暗黑模式
                </div>
            </div>
        </div>
        <button class="next-btn" id="next-btn">下一步</button>
        <div class="reminder-message" id="reminder-message">当前界面还有问题未回答</div>
    </div>
    <div class="overlay"></div>

    <script>
        // 从URL参数获取当前图片信息
        const urlParams = new URLSearchParams(window.location.search);
        const currentImg = urlParams.get('img');
        
        // 从sessionStorage获取标注数据和图片索引
        const annotations = JSON.parse(sessionStorage.getItem('annotations') || '[]');
        const imgOrder = JSON.parse(sessionStorage.getItem('imgOrder'));
        let imgIndex = parseInt(sessionStorage.getItem('imgIndex'));
        
        // 时间跟踪变量
        let pageStartTime = Date.now();
        
        // 设置进度显示
        document.getElementById('progress-header').textContent = `工具验证 第${imgIndex + 1}张（共14张）`;
        
        // 获取显示图片的元素
        const displayImg = document.getElementById('display-img');
        const viewButtons = document.getElementById('view-buttons');
        const annotationType = document.getElementById('annotation-type');
        
        // 设置原始图片
        displayImg.src = `test_image/${currentImg}`;

        // 设置工具验证结果图片
        function setToolImages() {
            // 获取原图文件名
            const baseName = currentImg.split('.')[0]; // 获取第一部分
            const extension = currentImg.split('.').pop(); // 获取扩展名
            
            // 获取工具结果容器和消息元素
            const toolResults = document.getElementById('tool-results');
            const toolCards = toolResults.querySelectorAll('.tool-card');
            const noDpMessage = document.getElementById('no-dp-message');
            
            // 检查是否是 no dp 图片
            if (baseName.toLowerCase().startsWith('no dp')) {
                toolCards.forEach(card => card.style.display = 'none');
                noDpMessage.style.display = 'block';
            } else {
                toolCards.forEach(card => card.style.display = 'block');
                noDpMessage.style.display = 'none';
                
                const toolImages = document.querySelectorAll('.tool-img');
                
                if (currentImg === '隐藏紧迫1.1.jpg') {
                    // 特殊处理隐藏紧迫1.1
                    toolImages[0].src = `test_image/隐藏紧迫1.2.jpg`;
                    toolImages[1].src = `test_image/隐藏紧迫1.3红.jpg`;
                    toolImages[2].src = `test_image/隐藏紧迫1.4红.jpg`;
                } else {
                    // 其他图片的常规处理
                    const match = currentImg.match(/(.+?)(\d+)\.1\./);
                    if (match) {
                        const prefix = match[1];
                        const number = match[2];
                        toolImages[0].src = `test_image/${prefix}${number}.2.${extension}`;
                        toolImages[1].src = `test_image/${prefix}${number}.3.${extension}`;
                        toolImages[2].src = `test_image/${prefix}${number}.4.${extension}`;
                    }
                }
            }
        }
        
        // 调用函数设置工具验证结果图片
        setToolImages();
        
        // 判断是否为无暗黑模式图片
        function isNoDpImg() {
            const noDpMsg = document.getElementById('no-dp-message');
            return noDpMsg && noDpMsg.style.display !== 'none';
        }
        

        
        // 只在非no dp图片时渲染问题弹窗和检查机制
        if (!isNoDpImg()) {
            // 创建标注按钮
            annotations.forEach((annotation, index) => {
                const btn = document.createElement('button');
                btn.textContent = `标注${index + 1}`;
                btn.className = 'view-btn';
                btn.dataset.index = index;
                viewButtons.appendChild(btn);
            });
            // 切换显示处理函数
            function switchView(index) {
                // 更新按钮状态
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.index === index.toString()) {
                        btn.classList.add('active');
                    }
                });
                
                if (index === -1) {
                    // 显示原图
                    displayImg.src = `test_image/${currentImg}`;
                    annotationType.classList.remove('show');
                } else {
                    // 显示标注
                    const annotation = annotations[index];
                    displayImg.src = annotation.annotatedImage;
                    annotationType.textContent = `用户反馈：${annotation.feedback}`;
                    annotationType.classList.add('show');
                }
            }
            // 绑定按钮点击事件
            viewButtons.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    switchView(index);
                }
            });
        }
        
        // 检查双弹窗答案是否完整
        function checkDpAnswersComplete() {
            const originalImgName = getCurrentOriginalImageName();
            if (originalImgName !== '隐藏紧迫1.1.jpg') {
                return true; // 非双弹窗图片，直接返回true
            }

            // 获取红蓝两套问题的预期答案数量
            if (!questionData) return true;
            const found = questionData.find(q => q.image === originalImgName);
            if (!found) return true;

            // 检查基本信息问题答案
            const redQuestions = found.question_name[0];
            const blueQuestions = found.question_name[1];
            
            // 每个问题需要2个答案（准确性和有用性）
            const expectedRedAnswers = redQuestions.length * 2;
            const expectedBlueAnswers = blueQuestions.length * 2;
            
            // 检查红色答案
            const redAnswerCount = Object.keys(dpAnswers.red || {}).length;
            const blueAnswerCount = Object.keys(dpAnswers.blue || {}).length;

            // 检查详细信息问题答案
            const redDetailQuestions = found.question_name1[0];
            const blueDetailQuestions = found.question_name1[1];
            
            // 每个详细问题也需要2个答案（准确性和有用性）
            const expectedRedDetailAnswers = redDetailQuestions.length * 2;
            const expectedBlueDetailAnswers = blueDetailQuestions.length * 2;
            
            // 检查详细信息红色答案
            const redDetailAnswerCount = Object.keys(detailDpAnswers.red || {}).length;
            const blueDetailAnswerCount = Object.keys(detailDpAnswers.blue || {}).length;
            
            // 基本信息和详细信息的答案都必须完整
            return redAnswerCount >= expectedRedAnswers && 
                   blueAnswerCount >= expectedBlueAnswers &&
                   redDetailAnswerCount >= expectedRedDetailAnswers &&
                   blueDetailAnswerCount >= expectedBlueDetailAnswers;
        }

        // 下一步按钮点击事件
        document.getElementById('next-btn').onclick = async function() {
            if (!isNoDpImg()) {
                const originalImgName = getCurrentOriginalImageName();
                const reminder = document.getElementById('reminder-message');
                
                if (originalImgName === '隐藏紧迫1.1.jpg') {
                    // 检查双弹窗答案
                    if (!checkDpAnswersComplete()) {
                        // 获取未完成的问题类型
                        const found = questionData.find(q => q.image === originalImgName);
                        if (found) {
                            const redQuestions = found.question_name[0];
                            const blueQuestions = found.question_name[1];
                            const redDetailQuestions = found.question_name1[0];
                            const blueDetailQuestions = found.question_name1[1];
                            
                            const expectedRedAnswers = redQuestions.length * 2;
                            const expectedBlueAnswers = blueQuestions.length * 2;
                            const expectedRedDetailAnswers = redDetailQuestions.length * 2;
                            const expectedBlueDetailAnswers = blueDetailQuestions.length * 2;
                            
                            const redAnswerCount = Object.keys(dpAnswers.red || {}).length;
                            const blueAnswerCount = Object.keys(dpAnswers.blue || {}).length;
                            const redDetailAnswerCount = Object.keys(detailDpAnswers.red || {}).length;
                            const blueDetailAnswerCount = Object.keys(detailDpAnswers.blue || {}).length;
                            
                            let reminderText = '请完成以下未回答的问题：<br>';
                            if (redAnswerCount < expectedRedAnswers) {
                                reminderText += '- 红色场景基本信息<br>';
                            }
                            if (blueAnswerCount < expectedBlueAnswers) {
                                reminderText += '- 蓝色场景基本信息<br>';
                            }
                            if (redDetailAnswerCount < expectedRedDetailAnswers) {
                                reminderText += '- 红色场景详细信息<br>';
                            }
                            if (blueDetailAnswerCount < expectedBlueDetailAnswers) {
                                reminderText += '- 蓝色场景详细信息<br>';
                            }
                            
                            reminder.innerHTML = reminderText;
                        } else {
                            reminder.textContent = '当前界面还有问题未回答';
                        }
                        reminder.style.display = 'block';
                        reminder.scrollIntoView({behavior: 'smooth', block: 'center'});
                        return;
                    }
                } else {
                    // 检查普通问题答案
                    const allRadios = document.querySelectorAll('.question-content input[type="radio"]');
                    const names = Array.from(new Set(Array.from(allRadios).map(r => r.name)));
                    let allAnswered = true;
                    for (const name of names) {
                        if (!document.querySelector('.question-content input[type="radio"][name="' + name + '"]:checked')) {
                            allAnswered = false;
                            break;
                        }
                    }
                    if (!allAnswered) {
                        reminder.textContent = '当前界面还有问题未回答';
                        reminder.style.display = 'block';
                        reminder.scrollIntoView({behavior: 'smooth', block: 'center'});
                        return;
                    } else {
                        reminder.style.display = 'none';
                    }
                }
            }
            // 收集并提交当前页面的答案（无论是否为最后一张图片都要提交）
            const answers = {};
            const originalImgName = getCurrentOriginalImageName();
            
            if (originalImgName === '隐藏紧迫1.1.jpg') {
                // 收集双弹窗答案
                answers.dpAnswers = dpAnswers;
                answers.detailDpAnswers = detailDpAnswers;

                // 同步保存位置信息价值评分（location_value），与普通图片保持一致
                const loc = document.querySelector('input[name="location_value"]:checked');
                if (loc) {
                    answers.location_value = loc.value;
                    console.log('找到location_value:', loc.value);
                } else {
                    console.log('未找到location_value的选中值');
                }
            } else {
                // 收集普通问题答案
                const allRadios = document.querySelectorAll('.question-content input[type="radio"]:checked');
                allRadios.forEach(radio => {
                    answers[radio.name] = radio.value;
                });
            }
            
            // 计算页面停留时间
            const pageEndTime = Date.now();
            const timeSpentSeconds = Math.round((pageEndTime - pageStartTime) / 1000);
            
            // 提交答案到服务器
            try {
                const submitSuccess = await window.submitToServer({
                    image: originalImgName,
                    answers: answers,
                    timeSpentSeconds: timeSpentSeconds,
                    timestamp: new Date().toISOString()
                }, 'tool-verify.html');
                
                if (!submitSuccess) {
                    // console.error('答案提交失败');
                    // 保存到localStorage作为备份
                    let savedAnswers = JSON.parse(localStorage.getItem('toolVerifyAnswers') || '[]');
                    savedAnswers.push({
                        image: originalImgName,
                        answers: answers,
                        timeSpentSeconds: timeSpentSeconds,
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('toolVerifyAnswers', JSON.stringify(savedAnswers));
                }
            } catch (error) {
                // console.error('提交错误：', error);
                // 保存到localStorage作为备份
                let savedAnswers = JSON.parse(localStorage.getItem('toolVerifyAnswers') || '[]');
                savedAnswers.push({
                    image: originalImgName,
                    answers: answers,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('toolVerifyAnswers', JSON.stringify(savedAnswers));
            }
            
            // 更新图片索引
            imgIndex++;
            if (imgIndex < imgOrder.length) {
                sessionStorage.removeItem('annotations');
                sessionStorage.setItem('imgIndex', imgIndex.toString());
                window.location.href = 'main-annotate.html';
            } else {
                // 跳转到问卷页面
                window.location.href = 'end.html';
            }
        };
        
        // 监听窗口大小变化，重新调整图片尺寸
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const activeBtn = document.querySelector('.view-btn.active');
                if (activeBtn) {
                    switchView(parseInt(activeBtn.dataset.index));
                }
            }, 100);
        });

        // 添加DP类型切换功能
        function setupDpTypeButtons() {
            const currentImg = urlParams.get('img');
            const dpTypeButtons = document.createElement('div');
            dpTypeButtons.className = 'dp-type-buttons';
            
            // 只为"隐藏紧迫1.1.jpg"显示按钮
            if (currentImg === '隐藏紧迫1.1.jpg') {
                dpTypeButtons.style.display = 'flex';
                
                // 添加标题文字
                const title = document.createElement('div');
                title.className = 'dp-type-title';
                title.textContent = '点击按钮切换当前界面暗黑模式信息';
                dpTypeButtons.appendChild(title);
                
                // 创建红色DP按钮
                const redBtn = document.createElement('button');
                redBtn.className = 'dp-type-btn red active';
                redBtn.innerHTML = '<svg viewBox="0 0 24 24" width="24" height="24"><text x="12" y="14" fill="#333333" text-anchor="middle" style="font-size: 7.5px; font-weight: bold;">红色DP</text></svg>';
                redBtn.title = '红色DP';
                redBtn.addEventListener('click', async () => {
                    await switchDpType('红');
                });
                
                // 创建蓝色DP按钮
                const blueBtn = document.createElement('button');
                blueBtn.className = 'dp-type-btn blue';
                blueBtn.innerHTML = '<svg viewBox="0 0 24 24" width="24" height="24"><text x="12" y="14" fill="#333333" text-anchor="middle" style="font-size: 7.5px; font-weight: bold;">蓝色DP</text></svg>';
                blueBtn.title = '蓝色DP';
                blueBtn.addEventListener('click', async () => {
                    await switchDpType('蓝');
                });
                
                dpTypeButtons.appendChild(redBtn);
                dpTypeButtons.appendChild(blueBtn);
                
                // 将按钮添加到第一个tool-card中
                const firstToolCard = document.querySelector('.tool-card');
                firstToolCard.appendChild(dpTypeButtons);
            }
        }

        // 切换DP类型
        async function switchDpType(type) {
            // 立即更新状态变量
            currentDpType = type;
            
            const buttons = document.querySelectorAll('.dp-type-btn');
            const toolImages = document.querySelectorAll('.tool-img');
            
            // 立即更新按钮状态
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if ((type === '红' && btn.classList.contains('red')) ||
                    (type === '蓝' && btn.classList.contains('blue'))) {
                    btn.classList.add('active');
                    // 添加过渡动画
                    btn.style.transform = 'scale(1.15)';
                    setTimeout(() => {
                        btn.style.transform = '';
                    }, 300);
                }
            });
            
            // 更新图片
            const baseName = '隐藏紧迫1';
            toolImages[1].src = `test_image/${baseName}.3${type}.jpg`;
            toolImages[2].src = `test_image/${baseName}.4${type}.jpg`;
            
            // 更新弹窗的可点击状态
            updatePopupClickability();
            updateTriggerClickability();
            
            // 更新详细信息相关状态
            updateDetailPopupClickability();
            updateDetailTriggerClickability();
            
            // 切换按钮后自动收起所有弹窗
            document.querySelectorAll('.question-content.show').forEach(popup => {
                popup.classList.remove('show');
                // 只对双弹窗设置display:none
                if (popup.id === 'redDpPopup' || popup.id === 'blueDpPopup' ||
                    popup.id === 'redDetailDpPopup' || popup.id === 'blueDetailDpPopup') {
                    popup.style.display = 'none';
                }
            });
            
            // console.log(`已切换到${type}色场景，并更新了所有状态`);
        }

        // 在页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            setToolImages();
            setupDpTypeButtons();
        });

        // 修改问题弹窗交互逻辑
        document.addEventListener('DOMContentLoaded', function() {
            const questionTriggers = document.querySelectorAll('.question-trigger');
            
            // 为每个问号按钮和弹窗分配唯一data-qid
            questionTriggers.forEach((trigger, idx) => {
                trigger.setAttribute('data-qid', 'qpopup-' + idx);
                const content = trigger.parentElement.querySelector('.question-content');
                if (content) content.setAttribute('data-qid', 'qpopup-' + idx);
            });
            
            questionTriggers.forEach(trigger => {
                trigger.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    // 通过data-qid在body下查找对应弹窗
                    const qid = this.getAttribute('data-qid');
                    const content = document.querySelector('.question-content[data-qid="' + qid + '"]');
                    
                    if (!content) {
                        // console.error('找不到对应的弹窗内容:', qid);
                        return;
                    }
                    
                    const isVisible = content.classList.contains('show');
                    
                    // 如果是"界面暗黑模式详细信息"卡片的问号按钮（第三个）
                    if (qid === 'qpopup-2') {
                        const originalImgName = getCurrentOriginalImageName();
                        
                        if (originalImgName === '隐藏紧迫1.1.jpg') {
                            // 对于隐藏紧迫1.1.jpg，显示对应的双弹窗
                            const dpType = getCurrentDpType();
                            showDetailDpPopup(dpType === '红' ? 'red' : 'blue');
                            return; // 直接返回，不执行后续的通用弹窗逻辑
                        }
                    }
                    // 如果是"界面暗黑模式基本信息"卡片的问号按钮（第二个）
                    else if (qid === 'qpopup-1') {
                        const originalImgName = getCurrentOriginalImageName();
                        
                        if (originalImgName === '隐藏紧迫1.1.jpg') {
                            // 对于隐藏紧迫1.1.jpg，显示对应的双弹窗
                            const dpType = getCurrentDpType();
                            showDpPopup(dpType === '红' ? 'red' : 'blue');
                            return; // 直接返回，不执行后续的通用弹窗逻辑
                        }
                    }
                    
                    // 关闭所有其他打开的问题弹窗
                    document.querySelectorAll('.question-content.show').forEach(popup => {
                        if (popup !== content) {
                            popup.classList.remove('show');
                        }
                    });
                    
                    // 动态定位弹窗
                    if (!isVisible) {
                        // 获取按钮在页面中的位置
                        const rect = this.getBoundingClientRect();
                        const popupWidth = 400;
                        const popupHeight = 320; // 预估高度
                        let left = rect.right + 12;
                        let top = rect.top;
                        // 如果右侧空间不足，向左展开
                        if (left + popupWidth > window.innerWidth) {
                            left = rect.left - popupWidth - 12;
                        }
                        // 如果下方空间不足，向上展开
                        if (top + popupHeight > window.innerHeight) {
                            top = window.innerHeight - popupHeight - 20;
                        }
                        if (top < 10) top = 10;
                        // 显示时强制append到body最后，确保在最上层
                        if (content.parentElement !== document.body || document.body.lastChild !== content) {
                            document.body.appendChild(content);
                        }
                        content.style.zIndex = 99999;
                        content.style.left = left + 'px';
                        content.style.top = top + 'px';
                    }
                    // 切换当前弹窗的显示状态
                    content.classList.toggle('show');
                });
            });
            
            // 可拖拽弹窗功能
            let dragTarget = null, offsetX = 0, offsetY = 0;
            document.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('question-content')) {
                    dragTarget = e.target;
                    const rect = dragTarget.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;
                    document.body.style.userSelect = 'none';
                }
            });
            document.addEventListener('mousemove', function(e) {
                if (dragTarget) {
                    let left = e.clientX - offsetX;
                    let top = e.clientY - offsetY;
                    // 限制弹窗不超出窗口
                    left = Math.max(0, Math.min(left, window.innerWidth - dragTarget.offsetWidth));
                    top = Math.max(0, Math.min(top, window.innerHeight - dragTarget.offsetHeight));
                    dragTarget.style.left = left + 'px';
                    dragTarget.style.top = top + 'px';
                }
            });
            document.addEventListener('mouseup', function() {
                dragTarget = null;
                document.body.style.userSelect = '';
            });
            
            // 点击其他地方关闭弹窗
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.question-popup') && 
                    !e.target.closest('.question-content') && 
                    !e.target.closest('.dp-popup-trigger') &&
                    !e.target.closest('.dp-type-btn')) {
                    document.querySelectorAll('.question-content.show').forEach(popup => {
                        popup.classList.remove('show');
                        // 只对双弹窗设置display:none，普通弹窗保持原有逻辑
                        if (popup.id === 'redDpPopup' || popup.id === 'blueDpPopup') {
                            popup.style.display = 'none';
                        }
                    });
                }
            });
        });

        // 监听所有评分，补全后自动隐藏提醒
        if (!isNoDpImg()) {
            document.querySelectorAll('.question-content input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const allRadios = document.querySelectorAll('.question-content input[type="radio"]');
                    const names = Array.from(new Set(Array.from(allRadios).map(r => r.name)));
                    let allAnswered = true;
                    for (const name of names) {
                        if (!document.querySelector('.question-content input[type="radio"][name="' + name + '"]:checked')) {
                            allAnswered = false;
                            break;
                        }
                    }
                    if (allAnswered) {
                        document.getElementById('reminder-message').style.display = 'none';
                    }
                });
            });
        }

        // 读取question.json并缓存
        let questionData = null;
        async function loadQuestionData() {
            if (questionData) return questionData;
            
            const maxRetries = 3;
            let retryCount = 0;
            
            const tryLoadData = async () => {
                try {
                    const res = await fetch('question.json');
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    questionData = await res.json();
                    // console.log('成功加载问题数据:', questionData);
                    return questionData;
                } catch (error) {
                    // console.error(`加载问题数据失败 (第${retryCount + 1}次):`, error.message);
                    
                    if (retryCount < maxRetries - 1) {
                        retryCount++;
                        // console.log(`将在1秒后重试...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return tryLoadData();
                    } else {
                        // console.error('问题数据加载最终失败');
                        alert('加载问题数据失败: ' + error.message + '\n请刷新页面重试');
                        return [];
                    }
                }
            };
            
            return tryLoadData();
        }

        // 根据图片名获取问题数组
        function getQuestionsByImg(imgName, dpType = null) {
            if (!questionData) {
                return [];
            }
            
            const found = questionData.find(q => q.image === imgName);
            
            if (!found) {
                return [];
            }
            
            // 处理隐藏紧迫1.1.jpg的特殊情况（二维数组）
            if (imgName === '隐藏紧迫1.1.jpg' && Array.isArray(found.question_name[0])) {
                if (dpType === '红') {
                    return found.question_name[0];
                } else if (dpType === '蓝') {
                    return found.question_name[1];
                } else {
                    // 默认返回红色的问题
                    return found.question_name[0];
                }
            }
            
            return found.question_name;
        }

        // 根据图片名获取详细信息问题数组（使用question_name1）
        function getDetailQuestionsByImg(imgName, dpType = null) {
            // console.log('获取详细信息问题:', imgName, dpType);
            // console.log('当前问题数据:', questionData);
            
            if (!questionData) {
                // console.log('问题数据未加载');
                return [];
            }
            
            const found = questionData.find(q => q.image === imgName);
            // console.log('找到的问题配置:', found);
            
            if (!found || !found.question_name1) {
                // console.log('未找到问题或question_name1不存在');
                return [];
            }
            
            // 处理隐藏紧迫1.1.jpg的特殊情况（二维数组）
            if (imgName === '隐藏紧迫1.1.jpg' && Array.isArray(found.question_name1[0])) {
                // console.log('处理隐藏紧迫1.1.jpg的特殊情况');
                if (dpType === '红') {
                    // console.log('返回红色问题:', found.question_name1[0]);
                    return found.question_name1[0];
                } else if (dpType === '蓝') {
                    // console.log('返回蓝色问题:', found.question_name1[1]);
                    return found.question_name1[1];
                } else {
                    // console.log('未指定类型，默认返回红色问题');
                    return found.question_name1[0];
                }
            }
            
            // console.log('返回普通问题:', found.question_name1);
            return found.question_name1;
        }

        // 存储双弹窗的答案
        let dpAnswers = {
            red: {},
            blue: {}
        };

        // 存储详细信息双弹窗的答案
        let detailDpAnswers = {
            red: {},
            blue: {}
        };

        // 渲染界面暗黑模式基本信息卡片的问题弹窗
        async function renderBasicInfoQuestions(imgName, dpType = null) {
            //console.log('开始渲染基本信息问题:', imgName, dpType);
            
            try {
                await loadQuestionData();
                
                if (imgName === '隐藏紧迫1.1.jpg') {
                    // 为隐藏紧迫1.1.jpg创建双弹窗
                    //console.log('为隐藏紧迫1.1.jpg创建双弹窗');
                    await createDualPopups(imgName);
                    return;
                }
                
                // 为其他图片创建普通弹窗
                const questions = getQuestionsByImg(imgName, dpType);
                //console.log('获取到的问题:', questions);
                
                const toolCards = document.querySelectorAll('.tool-card');
                //console.log('找到的tool-card数量:', toolCards.length);
                
                if (toolCards.length < 2) {
                    // console.error('找不到第二个tool-card元素');
                    return;
                }
                
                const popup = toolCards[1].querySelector('.question-content');
                if (!popup) {
                    // console.error('找不到question-content元素');
                    return;
                }
                
                popup.innerHTML = '';
                
                if (questions.length === 0) {
                    //console.log('没有找到问题数据');
                    popup.innerHTML = '<div style="text-align: center; color: #666;">暂无问题数据</div>';
                    return;
                }
                
                //console.log('开始生成问题HTML');
                questions.forEach((q, idx) => {
                    if (idx > 0) popup.innerHTML += '<hr style="margin: 1rem 0;">';
                    popup.innerHTML += `
                        <div class="question-item">
                            <div class="question-text" style="font-weight: bold; margin-bottom: 0.5rem;">${q}</div>
                        </div>
                        <div class="question-item" style="margin-bottom:0.5rem;">
                            <div class="question-text" style="flex:0 0 3.5em;">准确</div>
                            <div class="rating-options">
                                ${[1,2,3,4,5].map(i=>`<div class='rating-option'><input type='radio' name='${q}_accuracy' value='${i}'><label>${i}${i === 5 ? '（分数制）' : ''}</label></div>`).join('')}
                            </div>
                        </div>
                        <div class="question-item" style="margin-bottom:0.5rem;">
                            <div class="question-text" style="flex:0 0 3.5em;">有用</div>
                            <div class="rating-options">
                                ${[1,2,3,4,5].map(i=>`<div class='rating-option'><input type='radio' name='${q}_useful' value='${i}'><label>${i}${i === 5 ? '（分数制）' : ''}</label></div>`).join('')}
                            </div>
                        </div>
                    `;
                });
                
                //console.log('基本信息问题渲染完成');
            } catch (error) {
                // console.error('渲染基本信息问题时出错:', error);
            }
        }

        // 渲染界面暗黑模式详细信息卡片的问题弹窗
        async function renderDetailInfoQuestions(imgName, dpType = null) {
            //console.log('开始渲染详细信息问题:', imgName, dpType);
            await loadQuestionData();
            
            if (imgName === '隐藏紧迫1.1.jpg') {
                //console.log('处理隐藏紧迫1.1.jpg的详细信息问题');
                // 为隐藏紧迫1.1.jpg创建双弹窗
                await createDetailDualPopups(imgName);
                return;
            }
            
            // 为其他图片创建普通弹窗
            const questions = getDetailQuestionsByImg(imgName, dpType);
            //console.log('获取到的详细信息问题:', questions);
            
            const popup = document.getElementById('detail-info-questions');
            if (!popup) {
                //console.log('未找到详细信息问题容器');
                return;
            }
            
            popup.innerHTML = '';
            
            if (questions.length === 0) {
                //console.log('没有详细信息问题数据');
                popup.innerHTML = '<div style="text-align: center; color: #666;">暂无问题数据</div>';
                return;
            }
            
            //console.log('开始生成详细信息问题HTML');
            questions.forEach((q, idx) => {
                if (idx > 0) popup.innerHTML += '<hr style="margin: 1rem 0;">';
                popup.innerHTML += `
                    <div class="question-item">
                        <div class="question-text" style="font-weight: bold; margin-bottom: 0.5rem;">${q}</div>
                    </div>
                    <div class="question-item" style="margin-bottom:0.5rem;">
                        <div class="question-text" style="flex:0 0 3.5em;">准确</div>
                        <div class="rating-options">
                            ${[1,2,3,4,5].map(i=>`<div class='rating-option'><input type='radio' name='detail_${q}_accuracy' value='${i}'><label>${i === 5 ? '5（分数制）' : i}</label></div>`).join('')}
                        </div>
                    </div>
                    <div class="question-item" style="margin-bottom:0.5rem;">
                        <div class="question-text" style="flex:0 0 3.5em;">有用</div>
                        <div class="rating-options">
                            ${[1,2,3,4,5].map(i=>`<div class='rating-option'><input type='radio' name='detail_${q}_useful' value='${i}'><label>${i === 5 ? '5（分数制）' : i}</label></div>`).join('')}
                        </div>
                    </div>
                `;
            });
            //console.log('详细信息问题HTML生成完成');
        }

        // 创建双弹窗（红蓝切换）
        async function createDualPopups(imgName) {
            const questionData = await loadQuestionData();
            const found = questionData.find(q => q.image === imgName);
            if (!found) return;

            const redQuestions = found.question_name[0];
            const blueQuestions = found.question_name[1];

            // 创建红色弹窗
            createDpPopup('red', redQuestions, '红色场景');
            // 创建蓝色弹窗
            createDpPopup('blue', blueQuestions, '蓝色场景');
            
            // 更新弹窗的可点击状态
            updatePopupClickability();
        }

        // 创建详细信息双弹窗（红蓝切换）
        async function createDetailDualPopups(imgName) {
            const questionData = await loadQuestionData();
            const found = questionData.find(q => q.image === imgName);
            if (!found) return;

            const redQuestions = found.question_name1[0];
            const blueQuestions = found.question_name1[1];

            // 创建红色详细信息弹窗
            createDetailDpPopup('red', redQuestions, '红色场景');
            // 创建蓝色详细信息弹窗
            createDetailDpPopup('blue', blueQuestions, '蓝色场景');
            
            // 更新详细信息弹窗的可点击状态
            updateDetailPopupClickability();
        }

        // 创建单个DP弹窗
        function createDpPopup(type, questions, title) {
            const popupId = `${type}DpPopup`;
            
            // 移除已存在的弹窗
            const existingPopup = document.getElementById(popupId);
            if (existingPopup) {
                existingPopup.remove();
            }

            // 创建新弹窗
            const popup = document.createElement('div');
            popup.id = popupId;
            popup.className = 'question-content dp-popup';
            popup.style.display = 'none';
            popup.style.position = 'fixed';
            popup.style.backgroundColor = type === 'red' ? '#ffebee' : '#e3f2fd';
            popup.style.border = `3px solid ${type === 'red' ? '#f44336' : '#2196f3'}`;
            popup.style.borderRadius = '8px';
            popup.style.padding = '1rem';
            popup.style.minWidth = '350px';
            popup.style.maxWidth = '450px';
            popup.style.maxHeight = '80vh';
            popup.style.overflowY = 'auto';
            popup.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
            
            let questionsHtml = `<div style="font-weight: bold; margin-bottom: 1rem; color: ${type === 'red' ? '#d32f2f' : '#1976d2'}; text-align: center;">${title}</div>`;
            
            questions.forEach((q, idx) => {
                if (idx > 0) questionsHtml += '<hr style="margin: 1rem 0;">';
                questionsHtml += `
                    <div class="question-item">
                        <div class="question-text" style="font-weight: bold; margin-bottom: 0.5rem;">${q}</div>
                    </div>
                    <div class="question-item" style="margin-bottom:0.5rem;">
                        <div class="question-text" style="flex:0 0 3.5em;">准确</div>
                        <div class="rating-options">
                            ${[1,2,3,4,5].map(i=>`<div class='rating-option'><input type='radio' name='${type}_${q}_accuracy' value='${i}'><label>${i === 5 ? '5（分数制）' : i}</label></div>`).join('')}
                        </div>
                    </div>
                    <div class="question-item" style="margin-bottom:0.5rem;">
                        <div class="question-text" style="flex:0 0 3.5em;">有用</div>
                        <div class="rating-options">
                            ${[1,2,3,4,5].map(i=>`<div class='rating-option'><input type='radio' name='${type}_${q}_useful' value='${i}'><label>${i === 5 ? '5（分数制）' : i}</label></div>`).join('')}
                        </div>
                    </div>
                `;
            });

            popup.innerHTML = questionsHtml;
            document.body.appendChild(popup);

            // 为单选按钮添加事件监听器，实时保存答案
            popup.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    saveDpAnswer(type, this.name, this.value);
                });
            });

            // 恢复之前保存的答案
            restoreDpAnswers(type);
        }

        // 保存双弹窗答案
        function saveDpAnswer(type, name, value) {
            if (!dpAnswers[type]) {
                dpAnswers[type] = {};
            }
            dpAnswers[type][name] = value;
        }

        // 恢复双弹窗答案
        function restoreDpAnswers(type) {
            if (!dpAnswers[type]) return;
            
            Object.keys(dpAnswers[type]).forEach(name => {
                const radio = document.querySelector(`input[name="${name}"][value="${dpAnswers[type][name]}"]`);
                if (radio) {
                    radio.checked = true;
                }
            });
        }

        // 创建单个详细信息DP弹窗
        function createDetailDpPopup(type, questions, title) {
            const popupId = `${type}DetailDpPopup`;
            
            // 移除已存在的弹窗
            const existingPopup = document.getElementById(popupId);
            if (existingPopup) {
                existingPopup.remove();
            }

            // 创建新弹窗
            const popup = document.createElement('div');
            popup.id = popupId;
            popup.className = 'question-content dp-popup';
            popup.style.display = 'none';
            popup.style.position = 'fixed';
            popup.style.backgroundColor = type === 'red' ? '#ffebee' : '#e3f2fd';
            popup.style.border = `3px solid ${type === 'red' ? '#f44336' : '#2196f3'}`;
            popup.style.borderRadius = '8px';
            popup.style.padding = '1rem';
            popup.style.minWidth = '350px';
            popup.style.maxWidth = '450px';
            popup.style.maxHeight = '80vh';
            popup.style.overflowY = 'auto';
            popup.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
            
            let questionsHtml = `<div style="font-weight: bold; margin-bottom: 1rem; color: ${type === 'red' ? '#d32f2f' : '#1976d2'}; text-align: center;">${title}</div>`;
            
            questions.forEach((q, idx) => {
                if (idx > 0) questionsHtml += '<hr style="margin: 1rem 0;">';
                questionsHtml += `
                    <div class="question-item">
                        <div class="question-text" style="font-weight: bold; margin-bottom: 0.5rem;">${q}</div>
                    </div>
                    <div class="question-item" style="margin-bottom:0.5rem;">
                        <div class="question-text" style="flex:0 0 3.5em;">准确</div>
                        <div class="rating-options">
                            ${[1,2,3,4,5].map(i=>`<div class='rating-option'><input type='radio' name='detail_${type}_${q}_accuracy' value='${i}'><label>${i === 5 ? '5（分数制）' : i}</label></div>`).join('')}
                        </div>
                    </div>
                    <div class="question-item" style="margin-bottom:0.5rem;">
                        <div class="question-text" style="flex:0 0 3.5em;">有用</div>
                        <div class="rating-options">
                            ${[1,2,3,4,5].map(i=>`<div class='rating-option'><input type='radio' name='detail_${type}_${q}_useful' value='${i}'><label>${i === 5 ? '5（分数制）' : i}</label></div>`).join('')}
                        </div>
                    </div>
                `;
            });

            popup.innerHTML = questionsHtml;
            document.body.appendChild(popup);

            // 为单选按钮添加事件监听器，实时保存答案
            popup.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    saveDetailDpAnswer(type, this.name, this.value);
                });
            });

            // 恢复之前保存的答案
            restoreDetailDpAnswers(type);
        }

        // 保存详细信息双弹窗答案
        function saveDetailDpAnswer(type, name, value) {
            if (!detailDpAnswers[type]) {
                detailDpAnswers[type] = {};
            }
            detailDpAnswers[type][name] = value;
        }

        // 恢复详细信息双弹窗答案
        function restoreDetailDpAnswers(type) {
            if (!detailDpAnswers[type]) return;
            
            Object.keys(detailDpAnswers[type]).forEach(name => {
                const radio = document.querySelector(`input[name="${name}"][value="${detailDpAnswers[type][name]}"]`);
                if (radio) {
                    radio.checked = true;
                }
            });
        }

        // 更新弹窗的可点击状态
        function updatePopupClickability() {
            const currentType = getCurrentDpType();
            const redPopup = document.getElementById('redDpPopup');
            const bluePopup = document.getElementById('blueDpPopup');
            
            if (redPopup) {
                if (currentType === '红') {
                    redPopup.style.opacity = '1';
                    redPopup.style.pointerEvents = 'auto';
                    redPopup.style.cursor = 'pointer';
                } else {
                    redPopup.style.opacity = '0.5';
                    redPopup.style.pointerEvents = 'none';
                    redPopup.style.cursor = 'not-allowed';
                }
            }
            
            if (bluePopup) {
                if (currentType === '蓝') {
                    bluePopup.style.opacity = '1';
                    bluePopup.style.pointerEvents = 'auto';
                    bluePopup.style.cursor = 'pointer';
                } else {
                    bluePopup.style.opacity = '0.5';
                    bluePopup.style.pointerEvents = 'none';
                    bluePopup.style.cursor = 'not-allowed';
                }
            }
        }

        // 更新详细信息弹窗的可点击状态
        function updateDetailPopupClickability() {
            const currentType = getCurrentDpType();
            const redPopup = document.getElementById('redDetailDpPopup');
            const bluePopup = document.getElementById('blueDetailDpPopup');
            
            if (redPopup) {
                if (currentType === '红') {
                    redPopup.style.opacity = '1';
                    redPopup.style.pointerEvents = 'auto';
                    redPopup.style.cursor = 'pointer';
                } else {
                    redPopup.style.opacity = '0.5';
                    redPopup.style.pointerEvents = 'none';
                    redPopup.style.cursor = 'not-allowed';
                }
            }
            
            if (bluePopup) {
                if (currentType === '蓝') {
                    bluePopup.style.opacity = '1';
                    bluePopup.style.pointerEvents = 'auto';
                    bluePopup.style.cursor = 'pointer';
                } else {
                    bluePopup.style.opacity = '0.5';
                    bluePopup.style.pointerEvents = 'none';
                    bluePopup.style.cursor = 'not-allowed';
                }
            }
        }

        // 显示对应的DP弹窗
        function showDpPopup(type) {
            // 隐藏所有弹窗
            document.querySelectorAll('.question-content').forEach(popup => {
                popup.classList.remove('show');
                // 只对双弹窗设置display:none
                if (popup.id === 'redDpPopup' || popup.id === 'blueDpPopup') {
                    popup.style.display = 'none';
                }
            });

            // 显示对应类型的弹窗
            const popup = document.getElementById(`${type}DpPopup`);
            if (popup) {
                // 动态定位弹窗 - 使用对应颜色的触发按钮作为参考点
                const triggerBtn = document.getElementById(`${type}Trigger`);
                if (!triggerBtn) return;
                
                const rect = triggerBtn.getBoundingClientRect();
                const popupWidth = 400;
                const popupHeight = 320;
                let left = rect.right + 12;
                let top = rect.top;
                
                if (left + popupWidth > window.innerWidth) {
                    left = rect.left - popupWidth - 12;
                }
                if (top + popupHeight > window.innerHeight) {
                    top = window.innerHeight - popupHeight - 20;
                }
                if (top < 10) top = 10;
                
                popup.style.left = left + 'px';
                popup.style.top = top + 'px';
                popup.style.zIndex = 99999;
                popup.style.display = 'block';
                popup.classList.add('show');
            }
        }

        // 显示对应的详细信息DP弹窗
        function showDetailDpPopup(type) {
            // 隐藏所有弹窗
            document.querySelectorAll('.question-content').forEach(popup => {
                popup.classList.remove('show');
                // 只对双弹窗设置display:none
                if (popup.id === 'redDetailDpPopup' || popup.id === 'blueDetailDpPopup') {
                    popup.style.display = 'none';
                }
            });

            // 显示对应类型的弹窗
            const popup = document.getElementById(`${type}DetailDpPopup`);
            if (popup) {
                // 动态定位弹窗 - 使用对应颜色的触发按钮作为参考点
                const triggerBtn = document.getElementById(`${type}DetailTrigger`);
                if (!triggerBtn) return;
                
                const rect = triggerBtn.getBoundingClientRect();
                const popupWidth = 400;
                const popupHeight = 320;
                let left = rect.right + 12;
                let top = rect.top;
                
                if (left + popupWidth > window.innerWidth) {
                    left = rect.left - popupWidth - 12;
                }
                if (top + popupHeight > window.innerHeight) {
                    top = window.innerHeight - popupHeight - 20;
                }
                if (top < 10) top = 10;
                
                popup.style.left = left + 'px';
                popup.style.top = top + 'px';
                popup.style.zIndex = 99999;
                popup.style.display = 'block';
                popup.classList.add('show');
            }
        }

        // 获取当前原图名
        function getCurrentOriginalImageName() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('img');
        }

        // 当前DP类型状态变量
        let currentDpType = '红'; // 默认红色
        
        // 获取当前DP类型（仅对隐藏紧迫1.1.jpg有效）
        function getCurrentDpType() {
            return currentDpType;
        }

        // 设置双弹窗触发按钮
        function setupDpPopupTriggers() {
            const originalImgName = getCurrentOriginalImageName();
            const redTrigger = document.getElementById('redTrigger');
            const blueTrigger = document.getElementById('blueTrigger');
            const redDetailTrigger = document.getElementById('redDetailTrigger');
            const blueDetailTrigger = document.getElementById('blueDetailTrigger');
            
            if (originalImgName === '隐藏紧迫1.1.jpg') {
                // 显示红蓝按钮
                redTrigger.style.display = 'flex';
                blueTrigger.style.display = 'flex';
                redDetailTrigger.style.display = 'flex';
                blueDetailTrigger.style.display = 'flex';
                
                // 添加基本信息点击事件
                redTrigger.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    if (getCurrentDpType() === '红') {
                        // 关闭其他所有弹窗
                        document.querySelectorAll('.question-content').forEach(popup => {
                            if (popup.id !== 'redDpPopup') {
                                popup.classList.remove('show');
                                popup.style.display = 'none';
                            }
                        });
                        showDpPopup('red');
                    }
                });
                
                blueTrigger.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    if (getCurrentDpType() === '蓝') {
                        // 关闭其他所有弹窗
                        document.querySelectorAll('.question-content').forEach(popup => {
                            if (popup.id !== 'blueDpPopup') {
                                popup.classList.remove('show');
                                popup.style.display = 'none';
                            }
                        });
                        showDpPopup('blue');
                    }
                });

                // 添加详细信息点击事件
                redDetailTrigger.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    if (getCurrentDpType() === '红') {
                        // 关闭其他所有弹窗
                        document.querySelectorAll('.question-content').forEach(popup => {
                            if (popup.id !== 'redDetailDpPopup') {
                                popup.classList.remove('show');
                                popup.style.display = 'none';
                            }
                        });
                        showDetailDpPopup('red');
                    }
                });
                
                blueDetailTrigger.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    if (getCurrentDpType() === '蓝') {
                        // 关闭其他所有弹窗
                        document.querySelectorAll('.question-content').forEach(popup => {
                            if (popup.id !== 'blueDetailDpPopup') {
                                popup.classList.remove('show');
                                popup.style.display = 'none';
                            }
                        });
                        showDetailDpPopup('blue');
                    }
                });
                
                // 更新按钮的可点击状态
                updateTriggerClickability();
                updateDetailTriggerClickability();
            }
        }

        // 更新触发按钮的可点击状态
        function updateTriggerClickability() {
            const currentType = getCurrentDpType();
            const redTrigger = document.getElementById('redTrigger');
            const blueTrigger = document.getElementById('blueTrigger');
            
            if (redTrigger) {
                if (currentType === '红') {
                    redTrigger.style.opacity = '1';
                    redTrigger.style.pointerEvents = 'auto';
                    redTrigger.style.cursor = 'pointer';
                } else {
                    redTrigger.style.opacity = '0.5';
                    redTrigger.style.pointerEvents = 'none';
                    redTrigger.style.cursor = 'not-allowed';
                }
            }
            
            if (blueTrigger) {
                if (currentType === '蓝') {
                    blueTrigger.style.opacity = '1';
                    blueTrigger.style.pointerEvents = 'auto';
                    blueTrigger.style.cursor = 'pointer';
                } else {
                    blueTrigger.style.opacity = '0.5';
                    blueTrigger.style.pointerEvents = 'none';
                    blueTrigger.style.cursor = 'not-allowed';
                }
            }
        }

        // 更新详细信息触发按钮的可点击状态
        function updateDetailTriggerClickability() {
            // console.log('更新详细信息触发按钮状态');
            const currentType = getCurrentDpType();
            const redDetailTrigger = document.getElementById('redDetailTrigger');
            const blueDetailTrigger = document.getElementById('blueDetailTrigger');
            
            if (redDetailTrigger) {
                if (currentType === '红') {
                    redDetailTrigger.style.opacity = '1';
                    redDetailTrigger.style.pointerEvents = 'auto';
                    redDetailTrigger.style.cursor = 'pointer';
                    // console.log('红色详细信息按钮已启用');
                } else {
                    redDetailTrigger.style.opacity = '0.5';
                    redDetailTrigger.style.pointerEvents = 'none';
                    redDetailTrigger.style.cursor = 'not-allowed';
                }
            }
            
            if (blueDetailTrigger) {
                if (currentType === '蓝') {
                    blueDetailTrigger.style.opacity = '1';
                    blueDetailTrigger.style.pointerEvents = 'auto';
                    blueDetailTrigger.style.cursor = 'pointer';
                    // console.log('蓝色详细信息按钮已启用');
                } else {
                    blueDetailTrigger.style.opacity = '0.5';
                    blueDetailTrigger.style.pointerEvents = 'none';
                    blueDetailTrigger.style.cursor = 'not-allowed';
                }
            }
        }

        // 页面加载后渲染初始问题
        document.addEventListener('DOMContentLoaded', async () => {
            // 先加载question.json数据
            await loadQuestionData();
            
            // 使用更可靠的方式等待页面元素加载完成
            const maxRetries = 5;
            let retryCount = 0;
            
            const tryRenderQuestions = async () => {
                const originalImgName = getCurrentOriginalImageName();
                // console.log('当前图片名称:', originalImgName);
                
                if (originalImgName) {
                    // 检查必要的DOM元素是否存在
                    const toolCards = document.querySelectorAll('.tool-card');
                    const questionContent = toolCards[1]?.querySelector('.question-content');
                    
                    if (!questionContent && retryCount < maxRetries) {
                        // console.log(`DOM元素未准备好，重试第${retryCount + 1}次`);
                        retryCount++;
                        setTimeout(tryRenderQuestions, 500);
                        return;
                    }
                    
                    if (originalImgName === '隐藏紧迫1.1.jpg') {
                        // 对于隐藏紧迫1.1.jpg，传递dpType参数
                        const dpType = getCurrentDpType();
                        // console.log('当前DP类型:', dpType);
                        
                        // 渲染基本信息问题
                        await renderBasicInfoQuestions(originalImgName, dpType);
                        
                        // 渲染详细信息问题
                        await renderDetailInfoQuestions(originalImgName, dpType);
                        // console.log('已尝试渲染详细信息问题');
                    } else {
                        // 对于其他图片，不传递dpType参数
                        await renderBasicInfoQuestions(originalImgName);
                        await renderDetailInfoQuestions(originalImgName);
                    }
                    
                    // 设置双弹窗触发按钮
                    setupDpPopupTriggers();
                    
                    // 更新详细信息触发按钮的可点击状态
                    updateDetailTriggerClickability();

                    // 添加点击空白处关闭弹窗的事件处理
                    document.addEventListener('click', function(e) {
                        // 如果点击的不是弹窗内容、不是触发按钮、不是问题按钮
                        if (!e.target.closest('.question-content') && 
                            !e.target.closest('.dp-popup-trigger') &&
                            !e.target.closest('.question-trigger')) {
                            // 关闭所有弹窗
                            document.querySelectorAll('.question-content').forEach(popup => {
                                popup.classList.remove('show');
                                if (popup.id && (popup.id.includes('DpPopup') || popup.id.includes('DetailDpPopup'))) {
                                    popup.style.display = 'none';
                                }
                            });
                        }
                    });
                } else if (retryCount < maxRetries) {
                    // console.log(`图片名称未获取到，重试第${retryCount + 1}次`);
                    retryCount++;
                    setTimeout(tryRenderQuestions, 300);
                }
            };
            
            // 开始尝试渲染问题
            tryRenderQuestions();
        });
    </script>
</body>
</html> 